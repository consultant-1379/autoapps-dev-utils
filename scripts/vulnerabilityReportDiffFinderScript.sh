#!/bin/bash
#
# COPYRIGHT Ericsson 2023
#
#
#
# The copyright to the computer program(s) herein is the property of
#
# Ericsson Inc. The programs may be used and/or copied only with written
#
# permission from Ericsson Inc. or in accordance with the terms and
#
# conditions stipulated in the agreement/contract under which the
#
# program(s) have been supplied.
#

# To compare two vulnerability reports from project root folder
# ./scripts/vulnerabilityReportDiffFinderScript.sh ./vulnerability-reports/Vulnerability_Report_baseline.md ./vulnerability-reports/Vulnerability_Report_diff.md
findDiffs() {
    baseline_file_name="$1"
    update_file_name="$2"
    echo "reading from baseline file:"
    echo "$baseline_file_name"
    baseline_cves=$(findCVEs "$baseline_file_name")
    echo "reading from baseline file:"
    echo "$update_file_name"
    update_cves=$(findCVEs "$update_file_name")

    #echo "removing"
    #echo "$baseline_cves"
    #echo "from"
    #echo "$update_cves"

    diff_cves=$(comm -23 <(echo "$update_cves" | sort) <(echo "$baseline_cves" | sort))
    #echo "diffs:"
    #echo "$diff_cves"
    declare -A uniq
    for k in $diff_cves ; do uniq[$k]=1 ; done
    echo "CVEs found in update but not in baseline:"
    echo ${!uniq[@]}
}

findCVEs() {
    vulnerabiltyReportFile="$1"
    grep -oE 'CVE-20[0-9]+-[0-9]+' "$vulnerabiltyReportFile" #update for 2024
}
# shell> ./localScripts/vulnerabilityReportDiffFinderScript.sh ./localScripts/vulnerability-reports/<baselineFile> ./localScripts/vulnerability-reports/<updateFile>
baselineFile="$1"
updateFile="$2"
findDiffs "$baselineFile" "$updateFile"